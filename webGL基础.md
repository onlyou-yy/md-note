## webGL 概念

WebGL（Web图形库）是一个JavaScript API。可在任何兼容的Web浏览器中渲染高性能的交互式3D和2D图形，而无需使用插件。webGL 和 canvas 2D 一样需要使用到`<canvas>`标签来提供展示的容器和环境，而且 webGL 可以根据 js 提供的数据和调用的 api 来直接将数据提供给GPU来计算。

在 webGL 上运行的代码需要有成对的方法，每对方法中一个叫顶点着色器， 另一个叫片断着色器，并且使用一种和C或C++类似的强类型的语言 [GLSL](https://webglfundamentals.org/webgl/lessons/zh_cn/webgl-shaders-and-glsl.html)。 (GL着色语言)。 每一对组合起来称作一个 *program*（着色程序）。



## webGL 坐标系

在 canvas 2D 中坐标系的原点是我们熟知的从从容器左上角距离和尺寸单位都是px，而在 webGL 中坐标系的原点是从容器的中心开始的，并且坐标的长度都是 1，所以在坐标系中空间范围是[-1,1]，也可以理解为比例[-1,1]的长度正式容器的宽高成度。

![image-20220419163310438](webGL基础/image-20220419163310438.png)

也就是在宽高为 300，200 的canvas 容器中，设置webGL 一个点坐标为（0.5，0.2），这个点会显示在`（150 + 150*0.5，100 + 100*0.2）`中。



## webGL 的工作流程

webGL 的工作流程其实也就是渲染的流程。在这里称之为渲染管线。

渲染管线就像一条流水线，由一系列具有特定功能的数字电路单元组成，下一个功能单元处理上一个功能单元生成的数据，逐级处理数据。

顶点着色器和片元着色器是可编程的功能单元，拥有更大的自主性，还有光栅器、深度测试等不可编程的功能单元。CPU会通过WebGL API和GPU通信，传递着色器程序和数据，GPU执行的着色器程序可以通过useProgram方法切换，传递数据就是把CPU主存中的数据传送到GPU的显存中。

![image-20220419164603534](/Users/a/Desktop/ljf/myfile/myGitServer/md-note/webGL基础/image-20220419164603534.png)

### 顶点着色器

顶点着色器是GPU渲染管线上一个可以执行着色器语言的功能单元，具体执行的就是顶点着色器程序，WebGL顶点着色器程序在Javascript中以字符串的形式存在，通过编译处理后传递给顶点着色器执行。 顶点着色器主要作用就是执行顶点着色器程序对顶点进行变换计算，比如顶点位置坐标执行进行旋转、平移等矩阵变换，变换后新的顶点坐标然后赋值给内置变量gl_Position，作为顶点着色器的输出，图元装配和光栅化环节的输入。

> 顶点着色器的内置变量除了gl_Position外还有gl_FrontFacing、gl_PointSize
>
> **attribute**：是存储限定符，表示接下来的变量是一个attribute变量。attribute 变量必须声明成全局变量，数据将从着色器外部传给该变量。
>
> **uniform**：用来从 js 程序向顶点着色器和片元着色器传输一致的数据

### 图元装配

顶点变换后的操作是图元装配(primitive assembly)，硬件上具体是怎么回事不用思考，从程序的角度来看，就是绘制函数drawArrays()或drawElements()第一个参数绘制模式mode控制顶点如何装配为图元， gl.LINES的定义的是把两个顶点装配成一个线条图元，gl.TRIANGLES定义的是三个顶点装配为一个三角面图元，gl.POINTS定义的是一个点域图元。

![image-20220419170403185](/Users/a/Desktop/ljf/myfile/myGitServer/md-note/webGL基础/image-20220419170403185.png)

### 光栅化

片元着色器和顶点着色器一样是GPU渲染管线上一个可以执行着色器程序的功能单元，顶点着色器处理的是逐顶点处理顶点数据，片元着色器是逐片元处理片元数据。通过给内置变量gl_FragColor赋值可以给每一个片元进行着色， 值可以是一个确定的RGBA值，可以是一个和片元位置相关的值，也可以是插值后的顶点颜色。除了给片元进行着色之外，通过关键字discard还可以实现哪些片元可以被丢弃，被丢弃的片元不会出现在帧缓冲区，自然不会显示在canvas画布上。

![image-20220419170531267](/Users/a/Desktop/ljf/myfile/myGitServer/md-note/webGL基础/image-20220419170531267.png)

